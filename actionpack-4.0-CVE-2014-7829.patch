From 0d0bc45188425016458e6408e517e7fc1784de49 Mon Sep 17 00:00:00 2001
From: Aaron Patterson <aaron.patterson@gmail.com>
Date: Wed, 5 Nov 2014 15:37:36 -0800
Subject: [PATCH] correctly escape backslashes in request path globs

make sure that unreadable files are also not leaked

CVE-2014-7829
---
 .../lib/action_dispatch/middleware/static.rb       |  4 +--
 actionpack/test/dispatch/static_test.rb            | 41 ++++++++++++++++++++++
 2 files changed, 43 insertions(+), 2 deletions(-)

diff --git a/actionpack/lib/action_dispatch/middleware/static.rb b/actionpack/lib/action_dispatch/middleware/static.rb
index df77021..2303447 100644
--- a/actionpack/lib/action_dispatch/middleware/static.rb
+++ b/actionpack/lib/action_dispatch/middleware/static.rb
@@ -19,7 +19,7 @@ def match?(path)
       paths = "#{full_path}#{ext}"
 
       matches = Dir[paths]
-      match = matches.detect { |m| File.file?(m) }
+      match = matches.detect { |m| File.file?(m) && File.readable?(m) }
       if match
         match.sub!(@compiled_root, '')
         ::Rack::Utils.escape(match)
@@ -42,7 +42,7 @@ def unescape_path(path)
     end
 
     def escape_glob_chars(path)
-      path.gsub(/[*?{}\[\]]/, "\\\\\\&")
+      path.gsub(/[*?{}\[\]\\]/, "\\\\\\&")
     end
 
     private
